<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SkyWallet PRO</title>

    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg: #0b0f19; --glass: rgba(255, 255, 255, .06);
            --primary: #4f46e5; --text: #fff; --danger: #f43f5e;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', Arial, sans-serif; }
        .hidden { display: none !important; }
        .container { max-width: 500px; margin: auto; padding: 15px; }
        
        /* Login UI Fix */
        #loginSection { 
            height: 100vh; display: flex; justify-content: center; align-items: center; 
            background: radial-gradient(circle at top right, #1e1b4b, #0b0f19);
        }
        .card { background: var(--glass); padding: 30px 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); width: 100%; max-width: 350px; text-align: center; }
        
        .wallet { background: linear-gradient(135deg, #4f46e5, #9333ea); padding: 25px; border-radius: 20px; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .btn { padding: 14px; border: none; border-radius: 12px; width: 100%; margin-top: 10px; font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 1rem; }
        .btn-google { background: white; color: black; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        input { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); color: white; margin-top: 10px; }
        .admin-req { background: rgba(244, 63, 94, .1); padding: 15px; border-radius: 15px; border: 1px solid var(--danger); margin-top: 15px; }
    </style>
</head>
<body>

<div id="loginSection">
    <div class="card">
        <h1 style="margin:0; font-size: 2.5rem; background: linear-gradient(#fff, #6366f1); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">SkyWallet</h1>
        <p style="opacity:0.7; margin-bottom:30px;">Apne paiso ko kaam par lagaye</p>
        <button class="btn btn-google" onclick="login()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/pwa_google_symbol.svg" width="22" alt="G">
            Google se Login karein
        </button>
    </div>
</div>

<div id="appSection" class="container hidden">
    <div style="display:flex; justify-content:space-between; align-items:center; padding: 10px 0;">
        <h3 id="uName" style="margin:0">User</h3>
        <button onclick="logout()" style="background:none; color:var(--danger); border:none; font-weight:bold; cursor:pointer;">Logout</button>
    </div>

    <div class="wallet">
        <p style="font-size: 0.8rem; opacity: 0.8; margin:0;">TOTAL BALANCE</p>
        <h1 id="balanceDisplay" style="margin: 5px 0; font-size: 2.5rem;">₹0</h1>
    </div>

    <div class="card" style="margin-top:20px;">
        <h4 style="margin:0;">Transaction Request</h4>
        <input type="number" id="amount" placeholder="Amount ₹ daalein">
        <div style="display:flex; gap:10px;">
            <button class="btn btn-primary" onclick="reqTx('Deposit')">Deposit</button>
            <button class="btn btn-primary" style="background:#334155" onclick="reqTx('Withdraw')">Withdraw</button>
        </div>
    </div>

    <div class="card">
        <h4 style="margin:0 0 10px;">My History</h4>
        <div id="history" style="font-size: 0.9rem;">Loading history...</div>
    </div>

    <div id="adminPanel" class="card hidden" style="border: 1px solid var(--danger);">
        <h4 style="color:var(--danger); margin:0;">Admin Dashboard</h4>
        <div id="adminRequests">No pending requests.</div>
    </div>
</div>

<script>
// FIREBASE CONFIG
const firebaseConfig = {
    apiKey: "AIzaSyB08YgLPpftxwvlKQQ9D4dRCEn4QXk-fks",
    authDomain: "investamount-2d60a.firebaseapp.com",
    projectId: "investamount-2d60a",
    storageBucket: "investamount-2d60a.firebasestorage.app",
    messagingSenderId: "1680550862",
    appId: "1:1680550862:web:5218a3fc4c1ba814cc599f"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const adminEmail = "onlinetechcenter786@gmail.com";

// LOGIN - Redirect logic for mobile
function login() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithRedirect(provider);
}

function logout() { auth.signOut().then(() => location.reload()); }

// CATCH REDIRECT RESULT
auth.getRedirectResult().catch(err => {
    if(err.code === 'auth/unauthorized-domain') {
        alert("Domain issue! Firebase authorized domains check karein.");
    }
});

// AUTH STATE OBSERVER
auth.onAuthStateChanged(user => {
    if (user) {
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("appSection").classList.remove("hidden");
        document.getElementById("uName").innerText = "Namaste, " + user.displayName.split(" ")[0];

        const uRef = db.collection("users").doc(user.uid);
        uRef.onSnapshot(doc => {
            if (!doc.exists) {
                uRef.set({ balance: 0, email: user.email });
            } else {
                document.getElementById("balanceDisplay").innerText = "₹" + (doc.data().balance || 0).toLocaleString();
            }
        });

        loadHistory(user.uid);

        if (user.email.toLowerCase() === adminEmail.toLowerCase()) {
            document.getElementById("adminPanel").classList.remove("hidden");
            loadAdmin();
        }
    } else {
        document.getElementById("loginSection").classList.remove("hidden");
        document.getElementById("appSection").classList.add("hidden");
    }
});

// REQUEST TRANSACTION
async function reqTx(type) {
    let amt = parseInt(document.getElementById("amount").value);
    if (!amt || amt <= 0) return alert("Valid amount daalein");

    let pending = await db.collection("requests").where("uid", "==", auth.currentUser.uid).where("status", "==", "pending").get();
    if (!pending.empty) return alert("Pehle se ek request pending hai");

    await db.collection("requests").add({
        uid: auth.currentUser.uid,
        email: auth.currentUser.email,
        amount: amt,
        type: type,
        status: "pending",
        time: Date.now()
    });

    document.getElementById("amount").value = "";
    alert("Request bhej di gayi!");
}

// USER HISTORY
function loadHistory(uid) {
    db.collection("requests").where("uid", "==", uid).orderBy("time", "desc").onSnapshot(snap => {
        let html = "";
        snap.forEach(doc => {
            let r = doc.data();
            let color = r.status === 'approved' ? '#10b981' : (r.status === 'rejected' ? '#f43f5e' : '#94a3b8');
            html += `<div style="padding:10px; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; justify-content:space-between;">
                <span>${r.type} ₹${r.amount}</span>
                <span style="color:${color}; font-weight:bold;">${r.status.toUpperCase()}</span>
            </div>`;
        });
        document.getElementById("history").innerHTML = html || "No history available";
    });
}

// ADMIN PANEL LOGIC
function loadAdmin() {
    db.collection("requests").where("status", "==", "pending").onSnapshot(snap => {
        let html = "";
        snap.forEach(doc => {
            let r = doc.data();
            html += `<div class="admin-req">
                <b>${r.email}</b><br>${r.type}: ₹${r.amount.toLocaleString()}<br>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class='btn btn-primary' style="margin:0" onclick="approve('${doc.id}','${r.uid}',${r.amount},'${r.type}')">Approve</button>
                    <button class='btn btn-danger' style="margin:0" onclick="reject('${doc.id}')">Reject</button>
                </div>
            </div>`;
        });
        document.getElementById("adminRequests").innerHTML = html || "No pending requests.";
    });
}

async function approve(id, uid, amt, type) {
    const uRef = db.collection("users").doc(uid);
    const doc = await uRef.get();
    let bal = doc.data().balance || 0;

    if (type === "Withdraw" && amt > bal) {
        alert("Balance kam hai!");
        return;
    }

    let newBal = (type === "Deposit") ? bal + amt : bal - amt;
    await uRef.update({ balance: newBal });
    await db.collection("requests").doc(id).update({ status: "approved" });
}

async function reject(id) {
    await db.collection("requests").doc(id).update({ status: "rejected" });
}
</script>
</body>
</html>
